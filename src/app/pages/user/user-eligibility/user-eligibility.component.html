<!-- {{ records| json}} -->

<!-- <div *ngFor="let record of records">
  <div *ngIf="record.examCheckRecord">
    Candidate Name: {{ record.examCheckRecord.candidateName }}
  </div>
  <div *ngIf="!record.examCheckRecord">
    No Exam Record Found.
  </div>
</div> -->


<div class="results-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="full-page-loading">
    <div class="spinner-container">
      <div class="big-spinner"></div>
      <p class="loading-text">Loading eligibility results...</p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="!isLoading && loadingError" class="error-message">
    <div class="error-icon">!</div>
    <h3>Failed to load results</h3>
    <p>Please try again later or contact support</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && !loadingError && (!records || records.length === 0)" class="empty-state">
    <div class="empty-state-card">
      <div class="empty-icon">ðŸ“­</div>
      <h3>No Results Available</h3>
      <p>We couldn't find any eligibility results. Consider checking <a routerLink="/user/checkResults/">here</a> </p>
    </div>
  </div>

  <!-- Results Container -->
  <div class="results-container" *ngIf="!isLoading && !loadingError && records && records.length > 0">
    <div *ngFor="let result of records" class="result-card" [class.expanded]="expandedResultId === result.id">
      <div class="card-header" (click)="toggleExpand(result.id)">
        <div class="header-content">
          <h3>
            <span *ngIf="result.examCheckRecord?.candidateName">{{ result.examCheckRecord!.candidateName }} - </span>
            Analysis {{ result.createdAt | date:'medium' }}

          </h3>
          <div class="badges">
            <span class="badge eligible">{{ getTotalEligiblePrograms(result) }} Eligible</span>
            <span class="badge alternative">{{ getTotalAlternativePrograms(result) }} Alternatives</span>
            <span *ngFor="let type of getUniversityTypes(result)" class="badge type">
              {{ type }}
            </span>
          </div>
        </div>
        <div class="actions">
          <button class="btn-icon" (click)="openPreview(result); $event.stopPropagation()" title="Preview">
            <i class="material-icons">visibility</i>
          </button>
          <!-- <button class="btn-icon" (click)="downloadAsJson(result); $event.stopPropagation()" title="Download JSON">
            <i class="material-icons">download</i>
          </button> -->
          <button class="btn-icon" (click)="downloadAsPdf(result); $event.stopPropagation()" title="Download PDF">
            <i class="material-icons">picture_as_pdf</i>
          </button>
          <i class="material-icons expand-icon">
            {{ expandedResultId === result.id ? 'expand_less' : 'expand_more' }}
          </i>
        </div>
      </div>

      <div *ngIf="expandedResultId === result.id" class="card-content">
        <div *ngFor="let university of result.universities" class="university-section">
          <h4>
            {{ university.universityName }}
            <span class="location">{{ university.location }}</span>
            <span class="type-badge">{{ university.type }}</span>
          </h4>














          <!-- ELIGIBLE PROGRAMS -->
          <div *ngIf="university!.eligiblePrograms!.length > 0" class="eligibility-wrapper">
            <div *ngFor="let category of result.selectedCategories" class="eligibility-category">
              <div *ngIf="hasProgramsInCategory(university.eligiblePrograms, category)">

                <!-- Category Title -->
                <div class="category-banner">
                  <span class="category-label">{{ category.toUpperCase() }}</span>
                </div>

                <!-- Loop Programs -->
                <div *ngFor="let program of getProgramsByCategory(university.eligiblePrograms, category)"
                  class="eligibility-card">
                  <div class="program-header">
                    <strong>{{ program.name }}</strong>
                    <div class="confidence-meter">
                      <div class="meter-label">Likelihood of Admission</div>
                      <div class="meter-bar">
                        <div class="meter-fill" [style.width.%]="program.percentage"></div>
                      </div>
                      <div class="meter-value">{{ program.percentage | number:'1.0-1' }}%</div>
                    </div>
                  </div>
                  <!-- <div class="card-header">
                    <div class="program-name" (click)="toggleCard($event)">
                      <span class="bullet">â–¸</span>
                      <strong>{{ program.name }}</strong>
                    </div>
                    <div class="admission-likelihood">
                      <div class="meter-label">Likelihood of Admission</div>
                      <div class="meter-track">
                        <div class="meter-progress" [style.width.%]="program.percentage"></div>
                      </div>
                      <span class="meter-value">{{ program.percentage | number:'1.0-1' }}%</span>
                    </div>
                  </div> -->

                  <!-- Core Subject Table -->
                  <div class="analysis-section" *ngIf="program.aiRecommendation?.recommendationText as text">
                    <ng-container *ngIf="parseRecommendation(text) as sections">
                      <div *ngIf="sections.core.length > 0" class="analysis-block">
                        <h3 class="analysis-title">ðŸ“˜ Core Subjects Analysis</h3>
                        <table class="analysis-table">
                          <thead>
                            <tr>
                              <th>STATUS</th>
                              <th>SUBJECT / REQUIREMENT</th>
                              <th>REMARKS</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let item of getVisibleItems(sections, 'core', program.id)"
                              [ngClass]="getStatusClass(item.status)">
                              <td class="status-cell">
                                <span class="status-icon">{{ getStatusIcon(item) }}</span>
                              </td>
                              <td class="subject-cell">
                                <strong>{{ item.subject }}</strong>
                                <div class="grade-info">
                                  <span *ngIf="item.yourGrade" class="your-grade">Your Grade: {{ item.yourGrade
                                    }},</span>
                                  <span *ngIf="item.requirement" class="required-grade">Required: {{ item.requirement
                                    }}</span>
                                </div>
                              </td>
                              <td class="remarks-cell">{{ item.remarks }}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>




                      <!-- ðŸ”„ ALTERNATIVE REQUIREMENTS -->
                      <div class="section-wrapper" *ngIf="sections.alternative.length > 0">
                        <h3 class="section-title">ðŸ”„ Alternative Requirements</h3>
                        <table class="eligibility-table">
                          <thead>
                            <tr>
                              <th class="status-col">Status</th>
                              <th class="subject-col">Subject / Requirement</th>
                              <th class="remarks-col">Remarks</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let item of getVisibleItems(sections, 'alternative', program.id)"
                              [ngClass]="getStatusClass(item.status)">
                              <td class="status-cell">
                                <span class="status-icon">{{ getStatusIcon(item) }}</span>
                              </td>
                              <td class="subject-cell">
                                <strong>{{ item.subject }}</strong>
                                <div class="grade-info" *ngIf="item.yourGrade || item.requirement">
                                  <span *ngIf="item.yourGrade" class="your-grade">Your Grade: {{ item.yourGrade
                                    }}</span>
                                  <span *ngIf="item.requirement" class="required-grade">Required: {{ item.requirement
                                    }}</span>
                                </div>
                              </td>
                              <td class="remarks-cell">{{ item.remarks }}</td>
                            </tr>
                          </tbody>
                        </table>
                        <button *ngIf="hasMoreItems(sections, 'alternative', 3)" class="show-all-btn"
                          (click)="toggleShowAll(program.id, 'alternative')">
                          {{ isShowingAll(program.id, 'alternative') ? 'â–² Show Less' : 'â–¼ Show (' +
                          (sections.alternative.length - 3) + ' more)' }}
                        </button>
                      </div>
                    </ng-container>



                  </div>

                </div>
              </div>
            </div>
          </div>











































          <!-- Alternative Programs Section - Grouped by Categories -->
          <div *ngIf="university!.alternativePrograms!.length > 0" class="programs-section">
            <h5>Alternative Programs</h5>

            <!-- Loop through selected categories -->
            <div *ngFor="let category of result.selectedCategories" class="category-section">
              <!-- Only show category if it has programs -->
              <div *ngIf="hasProgramsInCategory(university.alternativePrograms, category)">
                <h6 class="category-title">{{ category }}</h6>

                <!-- Programs in this category -->
                <div *ngFor="let program of getProgramsByCategory(university.alternativePrograms, category)"
                  class="program-card alternative">
                  <div class="program-header">
                    <strong>{{ program.name }} </strong>
                    <div class="confidence-meter">
                      <div class="meter-label">Likelihood of Admission</div>
                      <div class="meter-bar">
                        <div class="meter-fill" [style.width.%]="program.percentage"></div>
                      </div>
                      <div class="meter-value">{{ program.percentage | number:'1.0-1' }}%</div>
                    </div>
                  </div>



                  <!-- Collapsible explanations -->



                  <!-- Component Template with Show All/Less functionality -->
                  <div class="eligibility-container" *ngIf="program.aiRecommendation?.recommendationText as text">
                    <ng-container *ngIf="parseRecommendation(text) as sections">
                      <!-- ðŸ“š CORE SUBJECTS ANALYSIS -->
                      <div class="section-wrapper" *ngIf="sections.core.length > 0">
                        <h3 class="section-title">ðŸ“š Core Subjects Analysis</h3>
                        <table class="eligibility-table">
                          <thead>
                            <tr>
                              <th class="status-col">Status</th>
                              <th class="subject-col">Subject / Requirement</th>
                              <th class="remarks-col">Remarks</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let item of getVisibleItems(sections, 'core', program.id)"
                              [ngClass]="getStatusClass(item.status)">
                              <td class="status-cell">
                                <span class="status-icon">{{ getStatusIcon(item) }}</span>
                              </td>
                              <td class="subject-cell">
                                <strong>{{ item.subject }}</strong>
                                <div class="grade-info" *ngIf="item.yourGrade || item.requirement">
                                  <span *ngIf="item.yourGrade" class="your-grade">Your Grade: {{ item.yourGrade
                                    }}</span>
                                  <span *ngIf="item.requirement" class="required-grade">Required: {{ item.requirement
                                    }}</span>
                                </div>
                              </td>
                              <td class="remarks-cell">{{ item.remarks }}</td>
                            </tr>
                          </tbody>
                        </table>
                        <button *ngIf="hasMoreItems(sections, 'core', 3)" class="show-all-btn"
                          (click)="toggleShowAll(program.id, 'core')">
                          {{ isShowingAll(program.id, 'core') ? 'â–² Show Less' : 'â–¼ Show All (' + (sections.core.length
                          -
                          3) + ' more)' }}
                        </button>
                      </div>

                      <!-- ðŸ”„ ALTERNATIVE REQUIREMENTS -->
                      <div class="section-wrapper" *ngIf="sections.alternative.length > 0">
                        <h3 class="section-title">ðŸ”„ Alternative Requirements</h3>
                        <table class="eligibility-table">
                          <thead>
                            <tr>
                              <th class="status-col">Status</th>
                              <th class="subject-col">Subject / Requirement</th>
                              <th class="remarks-col">Remarks</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let item of getVisibleItems(sections, 'alternative', program.id)"
                              [ngClass]="getStatusClass(item.status)">
                              <td class="status-cell">
                                <span class="status-icon">{{ getStatusIcon(item) }}</span>
                              </td>
                              <td class="subject-cell">
                                <strong>{{ item.subject }}</strong>
                                <div class="grade-info" *ngIf="item.yourGrade || item.requirement">
                                  <span *ngIf="item.yourGrade" class="your-grade">Your Grade: {{ item.yourGrade
                                    }}</span>
                                  <span *ngIf="item.requirement" class="required-grade">Required: {{ item.requirement
                                    }}</span>
                                </div>
                              </td>
                              <td class="remarks-cell">{{ item.remarks }}</td>
                            </tr>
                          </tbody>
                        </table>
                        <button *ngIf="hasMoreItems(sections, 'alternative', 3)" class="show-all-btn"
                          (click)="toggleShowAll(program.id, 'alternative')">
                          {{ isShowingAll(program.id, 'alternative') ? 'â–² Show Less' : 'â–¼ Show All (' +
                          (sections.alternative.length - 3) + ' more)' }}
                        </button>
                      </div>
                    </ng-container>
                  </div>
                </div>





































              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div *ngIf="showModal" class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Detailed Preview</h3>
      <button class="close-btn" (click)="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div *ngIf="selectedResult">
        <h4>Analysis ID: {{ selectedResult.id }}</h4>
        <p>Created: {{ selectedResult.createdAt | date:'full' }}</p>

        <div *ngIf="selectedResult.examCheckRecord" class="exam-record">
          <h5>Exam Check Record</h5>
          <p>Status: {{ selectedResult.examCheckRecord.checkStatus || 'Not available' }}</p>
          <p>Payment: {{ selectedResult.examCheckRecord.paymentStatus }}</p>
        </div>

        <div class="summary">
          <div class="summary-item">
            <span class="summary-count">{{ getTotalEligiblePrograms(selectedResult) }}</span>
            <span>Eligible Programs</span>
          </div>
          <div class="summary-item">
            <span class="summary-count">{{ getTotalAlternativePrograms(selectedResult) }}</span>
            <span>Alternative Programs</span>
          </div>
          <div class="summary-item">
            <span class="summary-count">{{ selectedResult.universities.length }}</span>
            <span>Universities</span>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn-download" (click)="downloadAsJson(selectedResult)">
            <i class="material-icons">download</i> Download JSON
          </button>
          <button class="btn-download" (click)="downloadAsPdf(selectedResult)">
            <i class="material-icons">picture_as_pdf</i> Download PDF
          </button>
        </div>
      </div>
    </div>
  </div>
</div>